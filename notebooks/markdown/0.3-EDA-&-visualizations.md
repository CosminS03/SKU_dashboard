```python
import pandas as pd
from src import config

df = pd.read_csv("../data/interim/online_retail_no_outliers.csv")
```


```python
df["InvoiceDate"] = pd.to_datetime(df["InvoiceDate"])
units_sold_2010 = df[df["InvoiceDate"].dt.year == 2010][~df["InvoiceNo"].str.startswith('C')].groupby(
    by='SKU')["Quantity"].sum().reset_index()
```

    C:\Users\spanu\AppData\Local\Temp\ipykernel_20144\2912404946.py:2: UserWarning: Boolean Series key will be reindexed to match DataFrame index.
      units_sold_2010 = df[df["InvoiceDate"].dt.year == 2010][~df["InvoiceNo"].str.startswith('C')].groupby(
    


```python
units_bought_2010 = df[df["InvoiceDate"].dt.year == 2010][df["InvoiceNo"].str.startswith('C')].groupby(
    by='SKU')['Quantity'].sum().reset_index()
units_bought_2010["Quantity"] = abs(units_bought_2010["Quantity"])
```

    C:\Users\spanu\AppData\Local\Temp\ipykernel_20144\690186677.py:1: UserWarning: Boolean Series key will be reindexed to match DataFrame index.
      units_bought_2010 = df[df["InvoiceDate"].dt.year == 2010][df["InvoiceNo"].str.startswith('C')].groupby(
    


```python
str_2010 = pd.merge(units_sold_2010, units_bought_2010, on='SKU', how='outer', suffixes=('_sold', '_bought'))
```


```python
import numpy as np

str_2010 = str_2010.fillna(0)

str_2010['Sell_through_rate'] = (str_2010["Quantity_sold"] / str_2010["Quantity_bought"]) * 100

str_2010['Sell_through_rate'] = str_2010['Sell_through_rate'].replace([np.inf, -np.inf], 0)
```


```python
str_2010.sort_values(by='Sell_through_rate', ascending=False).head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SKU</th>
      <th>Quantity_sold</th>
      <th>Quantity_bought</th>
      <th>Sell_through_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1130</th>
      <td>22469</td>
      <td>884.0</td>
      <td>1.0</td>
      <td>88400.0</td>
    </tr>
    <tr>
      <th>1270</th>
      <td>22632</td>
      <td>639.0</td>
      <td>1.0</td>
      <td>63900.0</td>
    </tr>
    <tr>
      <th>1131</th>
      <td>22470</td>
      <td>470.0</td>
      <td>1.0</td>
      <td>47000.0</td>
    </tr>
    <tr>
      <th>1297</th>
      <td>22666</td>
      <td>396.0</td>
      <td>1.0</td>
      <td>39600.0</td>
    </tr>
    <tr>
      <th>288</th>
      <td>21175</td>
      <td>368.0</td>
      <td>1.0</td>
      <td>36800.0</td>
    </tr>
    <tr>
      <th>876</th>
      <td>22158</td>
      <td>365.0</td>
      <td>1.0</td>
      <td>36500.0</td>
    </tr>
    <tr>
      <th>1109</th>
      <td>22444</td>
      <td>350.0</td>
      <td>1.0</td>
      <td>35000.0</td>
    </tr>
    <tr>
      <th>673</th>
      <td>21871</td>
      <td>322.0</td>
      <td>1.0</td>
      <td>32200.0</td>
    </tr>
    <tr>
      <th>1485</th>
      <td>22900</td>
      <td>310.0</td>
      <td>1.0</td>
      <td>31000.0</td>
    </tr>
    <tr>
      <th>1056</th>
      <td>22383</td>
      <td>310.0</td>
      <td>1.0</td>
      <td>31000.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
units_sold_2011 = df[df["InvoiceDate"].dt.year == 2011][~df["InvoiceNo"].str.startswith('C')].groupby(
    by='SKU')['Quantity'].sum().reset_index()
```

    C:\Users\spanu\AppData\Local\Temp\ipykernel_20144\4244140033.py:1: UserWarning: Boolean Series key will be reindexed to match DataFrame index.
      units_sold_2011 = df[df["InvoiceDate"].dt.year == 2011][~df["InvoiceNo"].str.startswith('C')].groupby(
    


```python
units_bought_2011 = df[df["InvoiceDate"].dt.year == 2011][df["InvoiceNo"].str.startswith('C')].groupby(
    by='SKU')['Quantity'].sum().reset_index()
units_bought_2011['Quantity'] = abs(units_bought_2011['Quantity']) 
```

    C:\Users\spanu\AppData\Local\Temp\ipykernel_20144\202212572.py:1: UserWarning: Boolean Series key will be reindexed to match DataFrame index.
      units_bought_2011 = df[df["InvoiceDate"].dt.year == 2011][df["InvoiceNo"].str.startswith('C')].groupby(
    


```python
str_2011=pd.merge(units_sold_2011, units_bought_2011, on='SKU', how='outer', suffixes=['_sold', '_bought'])
```


```python
str_2011 = str_2011.fillna(0)

str_2011['Sell_through_rate'] = (str_2011['Quantity_sold'] / str_2011['Quantity_bought']) * 100
str_2011['Sell_through_rate'] = str_2011['Sell_through_rate'].replace([np.inf, -np.inf], 0)
```


```python
str_2011.sort_values(by='Sell_through_rate', ascending=False).tail(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SKU</th>
      <th>Quantity_sold</th>
      <th>Quantity_bought</th>
      <th>Sell_through_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>13</th>
      <td>16011</td>
      <td>580.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>16012</td>
      <td>557.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>16014</td>
      <td>409.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2672</th>
      <td>90146</td>
      <td>15.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2673</th>
      <td>90149</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2674</th>
      <td>90155</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2675</th>
      <td>90156</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2676</th>
      <td>90157</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2627</th>
      <td>90055</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2658</th>
      <td>90116</td>
      <td>61.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
sku_str = pd.merge(str_2010, str_2011, on='SKU', how='outer', suffixes=['_10', '_11'])

sku_str = sku_str.fillna(0)

sku_str['Sell_through_rate'] = (config.wght_2010 * sku_str['Sell_through_rate_10'] +
                                config.wght_2011 * sku_str['Sell_through_rate_11'])
```


```python
sku_str["Sell_through_rate"].max()
```




    np.float64(674820.0)




```python
sku_str.sort_values(by='Sell_through_rate', ascending=False).head(10)[
    ['SKU', 'Sell_through_rate_10', 'Sell_through_rate_11', 'Sell_through_rate']
]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SKU</th>
      <th>Sell_through_rate_10</th>
      <th>Sell_through_rate_11</th>
      <th>Sell_through_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1976</th>
      <td>23307</td>
      <td>0.0</td>
      <td>733500.0</td>
      <td>674820.0</td>
    </tr>
    <tr>
      <th>1336</th>
      <td>22578</td>
      <td>0.0</td>
      <td>651400.0</td>
      <td>599288.0</td>
    </tr>
    <tr>
      <th>1914</th>
      <td>23232</td>
      <td>0.0</td>
      <td>537600.0</td>
      <td>494592.0</td>
    </tr>
    <tr>
      <th>1318</th>
      <td>22560</td>
      <td>0.0</td>
      <td>385600.0</td>
      <td>354752.0</td>
    </tr>
    <tr>
      <th>293</th>
      <td>21122</td>
      <td>0.0</td>
      <td>373400.0</td>
      <td>343528.0</td>
    </tr>
    <tr>
      <th>826</th>
      <td>21982</td>
      <td>0.0</td>
      <td>332100.0</td>
      <td>305532.0</td>
    </tr>
    <tr>
      <th>295</th>
      <td>21124</td>
      <td>0.0</td>
      <td>287800.0</td>
      <td>264776.0</td>
    </tr>
    <tr>
      <th>1343</th>
      <td>22585</td>
      <td>0.0</td>
      <td>274800.0</td>
      <td>252816.0</td>
    </tr>
    <tr>
      <th>805</th>
      <td>21935</td>
      <td>0.0</td>
      <td>255600.0</td>
      <td>235152.0</td>
    </tr>
    <tr>
      <th>1082</th>
      <td>22296</td>
      <td>0.0</td>
      <td>241900.0</td>
      <td>222548.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
sku_str[sku_str['Sell_through_rate'] <= 100.0].sort_values(
    by='Sell_through_rate', ascending=False).head(10)[
        ['SKU','Sell_through_rate_10', 'Sell_through_rate_11', 'Sell_through_rate']]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SKU</th>
      <th>Sell_through_rate_10</th>
      <th>Sell_through_rate_11</th>
      <th>Sell_through_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1333</th>
      <td>22575</td>
      <td>1250.000000</td>
      <td>0.0</td>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>727</th>
      <td>21826</td>
      <td>1200.000000</td>
      <td>0.0</td>
      <td>96.000000</td>
    </tr>
    <tr>
      <th>194</th>
      <td>20936</td>
      <td>1200.000000</td>
      <td>0.0</td>
      <td>96.000000</td>
    </tr>
    <tr>
      <th>1549</th>
      <td>22820</td>
      <td>1200.000000</td>
      <td>0.0</td>
      <td>96.000000</td>
    </tr>
    <tr>
      <th>1492</th>
      <td>22747</td>
      <td>1166.666667</td>
      <td>0.0</td>
      <td>93.333333</td>
    </tr>
    <tr>
      <th>1296</th>
      <td>22536</td>
      <td>1081.818182</td>
      <td>0.0</td>
      <td>86.545455</td>
    </tr>
    <tr>
      <th>1590</th>
      <td>22878</td>
      <td>1000.000000</td>
      <td>0.0</td>
      <td>80.000000</td>
    </tr>
    <tr>
      <th>2501</th>
      <td>84685</td>
      <td>1000.000000</td>
      <td>0.0</td>
      <td>80.000000</td>
    </tr>
    <tr>
      <th>2413</th>
      <td>79164</td>
      <td>800.000000</td>
      <td>0.0</td>
      <td>64.000000</td>
    </tr>
    <tr>
      <th>2623</th>
      <td>85175</td>
      <td>800.000000</td>
      <td>0.0</td>
      <td>64.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
print(len(sku_str))
print(len(sku_str[sku_str['Sell_through_rate'] <= 100.0]))
```

    2730
    1358
    
