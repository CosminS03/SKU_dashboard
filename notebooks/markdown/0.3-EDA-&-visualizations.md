```python
import pandas as pd
from src import config

df = pd.read_csv("../data/interim/online_retail_transformed.csv")
```


```python
df["InvoiceDate"] = pd.to_datetime(df["InvoiceDate"])
units_sold_2010 = df[df["InvoiceDate"].dt.year == 2010][~df["InvoiceNo"].str.startswith('C')].groupby(
    by='SKU')["Quantity"].sum().reset_index()
```

    C:\Users\spanu\AppData\Local\Temp\ipykernel_17868\2765961807.py:2: UserWarning: Boolean Series key will be reindexed to match DataFrame index.
      units_sold_2010 = df[df["InvoiceDate"].dt.year == 2010][~df["InvoiceNo"].str.startswith('C')].groupby(
    


```python
units_bought_2010 = df[df["InvoiceDate"].dt.year == 2010][df["InvoiceNo"].str.startswith('C')].groupby(
    by='SKU')['Quantity'].sum().reset_index()
units_bought_2010["Quantity"] = abs(units_bought_2010["Quantity"])
```

    C:\Users\spanu\AppData\Local\Temp\ipykernel_17868\2804212507.py:1: UserWarning: Boolean Series key will be reindexed to match DataFrame index.
      units_bought_2010 = df[df["InvoiceDate"].dt.year == 2010][df["InvoiceNo"].str.startswith('C')].groupby(
    


```python
str_2010 = pd.merge(units_sold_2010, units_bought_2010, on='SKU', how='outer', suffixes=('_sold', '_bought'))
```


```python
import numpy as np

str_2010 = str_2010.fillna(0)

str_2010['Sell_through_rate'] = (str_2010["Quantity_sold"] / str_2010["Quantity_bought"]) * 100

str_2010['Sell_through_rate'] = str_2010['Sell_through_rate'].replace([np.inf, -np.inf], 0)
```


```python
str_2010.sort_values(by='Sell_through_rate', ascending=False).head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SKU</th>
      <th>Quantity_sold</th>
      <th>Quantity_bought</th>
      <th>Sell_through_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1196</th>
      <td>22469</td>
      <td>1799.0</td>
      <td>1.0</td>
      <td>179900.0</td>
    </tr>
    <tr>
      <th>1197</th>
      <td>22470</td>
      <td>1084.0</td>
      <td>1.0</td>
      <td>108400.0</td>
    </tr>
    <tr>
      <th>1095</th>
      <td>22355</td>
      <td>1981.0</td>
      <td>2.0</td>
      <td>99050.0</td>
    </tr>
    <tr>
      <th>1816</th>
      <td>84050</td>
      <td>977.0</td>
      <td>1.0</td>
      <td>97700.0</td>
    </tr>
    <tr>
      <th>1072</th>
      <td>22328</td>
      <td>1860.0</td>
      <td>2.0</td>
      <td>93000.0</td>
    </tr>
    <tr>
      <th>635</th>
      <td>21731</td>
      <td>1821.0</td>
      <td>2.0</td>
      <td>91050.0</td>
    </tr>
    <tr>
      <th>1350</th>
      <td>22632</td>
      <td>879.0</td>
      <td>1.0</td>
      <td>87900.0</td>
    </tr>
    <tr>
      <th>1902</th>
      <td>84945</td>
      <td>1453.0</td>
      <td>2.0</td>
      <td>72650.0</td>
    </tr>
    <tr>
      <th>1764</th>
      <td>71459</td>
      <td>704.0</td>
      <td>1.0</td>
      <td>70400.0</td>
    </tr>
    <tr>
      <th>1800</th>
      <td>82484</td>
      <td>1347.0</td>
      <td>2.0</td>
      <td>67350.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
units_sold_2011 = df[df["InvoiceDate"].dt.year == 2011][~df["InvoiceNo"].str.startswith('C')].groupby(
    by='SKU')['Quantity'].sum().reset_index()
```

    C:\Users\spanu\AppData\Local\Temp\ipykernel_17868\1497786374.py:1: UserWarning: Boolean Series key will be reindexed to match DataFrame index.
      units_sold_2011 = df[df["InvoiceDate"].dt.year == 2011][~df["InvoiceNo"].str.startswith('C')].groupby(by='SKU')['Quantity'].sum().reset_index()
    


```python
units_bought_2011 = df[df["InvoiceDate"].dt.year == 2011][df["InvoiceNo"].str.startswith('C')].groupby(
    by='SKU')['Quantity'].sum().reset_index()
units_bought_2011['Quantity'] = abs(units_bought_2011['Quantity']) 
```

    C:\Users\spanu\AppData\Local\Temp\ipykernel_17868\3557063808.py:1: UserWarning: Boolean Series key will be reindexed to match DataFrame index.
      units_bought_2011 = df[df["InvoiceDate"].dt.year == 2011][df["InvoiceNo"].str.startswith('C')].groupby(by='SKU')['Quantity'].sum().reset_index()
    


```python
str_2011=pd.merge(units_sold_2011, units_bought_2011, on='SKU', how='outer', suffixes=['_sold', '_bought'])
```


```python
str_2011 = str_2011.fillna(0)

str_2011['Sell_through_rate'] = (str_2011['Quantity_sold'] / str_2011['Quantity_bought']) * 100
str_2011['Sell_through_rate'] = str_2011['Sell_through_rate'].replace([np.inf, -np.inf], 0)
```


```python
str_2011.sort_values(by='Sell_through_rate', ascending=False).tail(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SKU</th>
      <th>Quantity_sold</th>
      <th>Quantity_bought</th>
      <th>Sell_through_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1260</th>
      <td>22475</td>
      <td>285.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2820</th>
      <td>90173</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1259</th>
      <td>22474</td>
      <td>249.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1258</th>
      <td>22473</td>
      <td>382.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1280</th>
      <td>22497</td>
      <td>191.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2800</th>
      <td>90138</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2799</th>
      <td>90137</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2798</th>
      <td>90136</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2797</th>
      <td>90135</td>
      <td>8.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>16008</td>
      <td>2878.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
sku_str = pd.merge(str_2010, str_2011, on='SKU', how='outer', suffixes=['_10', '_11'])

sku_str['Sell_through_rate'] = (config.wght_2010 * sku_str['Sell_through_rate_10'] +
                                config.wght_2011 * sku_str['Sell_through_rate_11'])
```


```python
sku_str[sku_str['Sell_through_rate'] <= 100.0].sort_values(
    by='Sell_through_rate', ascending=False).head(10)[
        ['SKU','Sell_through_rate_10', 'Sell_through_rate_11', 'Sell_through_rate']]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SKU</th>
      <th>Sell_through_rate_10</th>
      <th>Sell_through_rate_11</th>
      <th>Sell_through_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1381</th>
      <td>22575</td>
      <td>1250.000000</td>
      <td>0.0</td>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>201</th>
      <td>20936</td>
      <td>1200.000000</td>
      <td>0.0</td>
      <td>96.000000</td>
    </tr>
    <tr>
      <th>762</th>
      <td>21826</td>
      <td>1200.000000</td>
      <td>0.0</td>
      <td>96.000000</td>
    </tr>
    <tr>
      <th>1547</th>
      <td>22747</td>
      <td>1166.666667</td>
      <td>0.0</td>
      <td>93.333333</td>
    </tr>
    <tr>
      <th>2396</th>
      <td>35400</td>
      <td>14.285714</td>
      <td>100.0</td>
      <td>93.142857</td>
    </tr>
    <tr>
      <th>1212</th>
      <td>22394</td>
      <td>1033.333333</td>
      <td>0.0</td>
      <td>82.666667</td>
    </tr>
    <tr>
      <th>780</th>
      <td>21864</td>
      <td>1020.000000</td>
      <td>0.0</td>
      <td>81.600000</td>
    </tr>
    <tr>
      <th>1672</th>
      <td>22878</td>
      <td>1000.000000</td>
      <td>0.0</td>
      <td>80.000000</td>
    </tr>
    <tr>
      <th>2630</th>
      <td>84685</td>
      <td>1000.000000</td>
      <td>0.0</td>
      <td>80.000000</td>
    </tr>
    <tr>
      <th>496</th>
      <td>21411</td>
      <td>950.000000</td>
      <td>0.0</td>
      <td>76.000000</td>
    </tr>
  </tbody>
</table>
</div>


